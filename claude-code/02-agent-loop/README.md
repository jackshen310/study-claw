# æ¨¡å—äºŒï¼šAgent Loopï¼ˆæ™ºèƒ½ä½“å¾ªç¯ï¼‰â­ æœ€æ ¸å¿ƒ

> å­¦ä¹ ç›®æ ‡ï¼šæ·±åº¦ç†è§£ Claude Code çš„ Agent Loop è¿ä½œæœºåˆ¶ï¼ŒæŒæ¡"æ€è€ƒâ†’è¡ŒåŠ¨â†’è§‚å¯Ÿ"çš„å®Œæ•´å¾ªç¯
>
> è¿™æ˜¯æ•´ä¸ª Claude Code ä½“ç³»ä¸­**æœ€æ ¸å¿ƒ**çš„æ¨¡å—ï¼Œç†è§£å®ƒç­‰äºç†è§£äº† Agent çš„çµé­‚ã€‚

---

## 2.1 Think â†’ Tool Call â†’ Observe ä¸‰æ­¥å¾ªç¯åŸç†

### ä»€ä¹ˆæ˜¯ Agent Loopï¼Ÿ

Agent Loop æ˜¯ Claude Code çš„"å¿ƒè·³"ã€‚å¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> **LLM ä¸æ–­æ€è€ƒâ†’å†³å®šè°ƒç”¨å·¥å…·â†’è§‚å¯Ÿç»“æœâ†’ç»§ç»­æ€è€ƒï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚**

### ä¸‰æ­¥å¾ªç¯å›¾è§£

```
ç”¨æˆ·è¾“å…¥ï¼š"å¸®æˆ‘ä¿®å¤ app.js ä¸­çš„ bug"
         â”‚
         â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                AGENT LOOP                   â•‘
â•‘                                             â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  Step 1: THINKï¼ˆæ€è€ƒï¼‰              â”‚    â•‘
â•‘  â”‚  â€¢ æŠŠ messages å†å² + å·¥å…·å®šä¹‰      â”‚    â•‘
â•‘  â”‚    å‘é€ç»™ Claude API                â”‚    â•‘
â•‘  â”‚  â€¢ Claude åˆ†ææƒ…å†µï¼Œå†³å®šä¸‹ä¸€æ­¥      â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                 â”‚                           â•‘
â•‘                 â–¼                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  Step 2: ACTï¼ˆè¡ŒåŠ¨ï¼‰                â”‚    â•‘
â•‘  â”‚  â€¢ Claude è¾“å‡º tool_use è¯·æ±‚        â”‚    â•‘
â•‘  â”‚  â€¢ CLI è§£æå¹¶æ‰§è¡Œå¯¹åº”å·¥å…·           â”‚    â•‘
â•‘  â”‚    ï¼ˆReadæ–‡ä»¶ / æ‰§è¡ŒBash / å†™å…¥ç­‰ï¼‰ â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                 â”‚                           â•‘
â•‘                 â–¼                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  Step 3: OBSERVEï¼ˆè§‚å¯Ÿï¼‰            â”‚    â•‘
â•‘  â”‚  â€¢ å·¥å…·æ‰§è¡Œç»“æœä½œä¸º tool_result     â”‚    â•‘
â•‘  â”‚    è¿½åŠ åˆ° messages å†å²             â”‚    â•‘
â•‘  â”‚  â€¢ è¿”å›é¡¶éƒ¨ç»§ç»­å¾ªç¯                 â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                 â”‚                           â•‘
â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
â•‘    â”‚  stop_reason == end_turn â”‚              â•‘
â•‘    â”‚  ï¼ˆæ— å·¥å…·è°ƒç”¨ï¼Œä»»åŠ¡å®Œæˆï¼‰â”‚              â•‘
â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚
         â–¼
    è¾“å‡ºæœ€ç»ˆç»“æœç»™ç”¨æˆ·
```

### å®Œæ•´çš„ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼ˆå¯è§†åŒ–ï¼‰

ä»¥"ä¿®å¤ bug"ä¸ºä¾‹ï¼š

```
è½®æ¬¡ 1:
  [ç”¨æˆ·]   "å¸®æˆ‘ä¿®å¤ app.js ä¸­çš„ null æŒ‡é’ˆ bug"
  [Claude] æ€è€ƒï¼š"æˆ‘éœ€è¦å…ˆè¯»ä¸€ä¸‹ app.js"
           â†’ tool_use: Read("app.js")
  [CLI]    æ‰§è¡Œ Readï¼Œè¿”å›æ–‡ä»¶å†…å®¹
  [messages] è¿½åŠ  tool_result

è½®æ¬¡ 2:
  [Claude] æ€è€ƒï¼š"çœ‹åˆ°ç¬¬42è¡Œæœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ä¸Šä¸‹æ–‡"
           â†’ tool_use: Read("utils.js")
  [CLI]    æ‰§è¡Œ Readï¼Œè¿”å› utils.js å†…å®¹
  [messages] ç»§ç»­è¿½åŠ 

è½®æ¬¡ 3:
  [Claude] æ€è€ƒï¼š"æ‰¾åˆ°æ ¹å› äº†ï¼Œä¿®å¤ app.js ç¬¬42è¡Œ"
           â†’ tool_use: Write("app.js", ä¿®å¤åçš„å†…å®¹)
  [CLI]    æ‰§è¡Œå†™å…¥
  [messages] è¿½åŠ å†™å…¥ç»“æœ

è½®æ¬¡ 4:
  [Claude] æ€è€ƒï¼š"éªŒè¯ä¸€ä¸‹ä¿®å¤æ˜¯å¦æœ‰æ•ˆ"
           â†’ tool_use: Bash("node app.js")
  [CLI]    æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›è¾“å‡º
  [messages] è¿½åŠ è¿è¡Œç»“æœ

è½®æ¬¡ 5:
  [Claude] æ€è€ƒï¼š"è¿è¡Œæ­£å¸¸ï¼Œä»»åŠ¡å®Œæˆ"
           â†’ text: "å·²ä¿®å¤ app.js ç¬¬42è¡Œçš„ null æŒ‡é’ˆé—®é¢˜..."
           stop_reason: "end_turn"  â† æ²¡æœ‰ tool_useï¼
  [å¾ªç¯ç»“æŸ] æ˜¾ç¤ºç»“æœç»™ç”¨æˆ·
```

---

## 2.2 ä½•æ—¶ç»ˆæ­¢å¾ªç¯ï¼šåœæ­¢æ¡ä»¶åˆ¤æ–­é€»è¾‘

### stop_reason å†³å®šä¸€åˆ‡

æ¯æ¬¡ API å“åº”éƒ½åŒ…å« `stop_reason`ï¼Œå®ƒæ˜¯å¾ªç¯çš„"æ–¹å‘ç›˜"ï¼š

| stop_reason     | å«ä¹‰               | Agent è¡Œä¸º             |
| --------------- | ------------------ | ---------------------- |
| `tool_use`      | æ¨¡å‹è¦è°ƒç”¨å·¥å…·     | æ‰§è¡Œå·¥å…· â†’ ç»§ç»­å¾ªç¯    |
| `end_turn`      | æ¨¡å‹è®¤ä¸ºä»»åŠ¡å®Œæˆ   | **é€€å‡ºå¾ªç¯**ï¼Œæ˜¾ç¤ºç»“æœ |
| `max_tokens`    | è¾“å‡ºè¾¾åˆ°æœ€å¤§ token | å‹ç¼©ä¸Šä¸‹æ–‡ï¼Œå¤„ç†æˆªæ–­   |
| `stop_sequence` | é‡åˆ°åœæ­¢è¯         | é€€å‡ºå¾ªç¯ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰   |

### è¿­ä»£å®‰å…¨é˜€ï¼šæœ€å¤§å¾ªç¯æ¬¡æ•°

```
é»˜è®¤æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼š100 æ¬¡
ï¼ˆå¯é€šè¿‡é…ç½®ä¿®æ”¹ï¼šmaxIterationsï¼‰

ä¸ºä»€ä¹ˆéœ€è¦é™åˆ¶ï¼Ÿ
â†’ é˜²æ­¢ Agent é™·å…¥æ— é™å¾ªç¯ï¼ˆå¦‚ï¼šé‡å¤è¯»åŒä¸€ä¸ªæ–‡ä»¶å´æ²¡æœ‰è¿›å±•ï¼‰
â†’ é˜²æ­¢æ„å¤–äº§ç”Ÿæé«˜ API è´¹ç”¨

è§¦å‘é™åˆ¶åï¼š
â†’ å¼ºåˆ¶åœæ­¢å¾ªç¯
â†’ å‘ŠçŸ¥ç”¨æˆ·ä»»åŠ¡æœªå®Œæˆ
â†’ ç”¨æˆ·å¯ä»¥ç»§ç»­è¿½é—®ï¼Œäººå·¥å¼•å¯¼
```

### ç”¨æˆ·ä¸»åŠ¨æ‰“æ–­ï¼ˆh2A é˜Ÿåˆ—çš„ä½œç”¨ï¼‰

```
ç”¨æˆ·åœ¨ Agent è¿è¡Œä¸­æŒ‰ Ctrl+Cï¼š
  â”‚
  â–¼
h2A æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ‰“æ–­ä¿¡å·
  â”‚
  â–¼
å½“å‰ API æµå¼å“åº”è¢«ä¸­æ­¢ï¼ˆinterruptible streamingï¼‰
  â”‚
  â–¼
Agent Loop åœ¨å®‰å…¨æ£€æŸ¥ç‚¹é€€å‡º
ï¼ˆä¸ä¼šåœ¨å·¥å…·æ‰§è¡Œä¸­é€”å¼ºè¡Œç»ˆæ­¢ï¼Œé¿å…æ–‡ä»¶æŸåï¼‰
  â”‚
  â–¼
ç­‰å¾…ç”¨æˆ·æ–°æŒ‡ä»¤ï¼ˆå¯ä»¥ä»å½“å‰è¿›åº¦ç»§ç»­ï¼‰
```

---

## 2.3 å¤šè½®å¯¹è¯çš„ messages æ•°ç»„å¦‚ä½•æ¼”åŒ–

### messages æ˜¯ Agent çš„"è®°å¿†"

LLM æ— çŠ¶æ€ï¼Œmessages æ•°ç»„å°±æ˜¯å®ƒçš„"å¤–éƒ¨è®°å¿†"ã€‚æ¯è½®å¾ªç¯åï¼Œæ•°ç»„éƒ½ä¼šå¢é•¿ã€‚

### ä¸€æ¬¡å®Œæ•´ä»»åŠ¡çš„ messages æ¼”åŒ–è¿‡ç¨‹

```javascript
// åˆå§‹çŠ¶æ€ï¼šåªæœ‰ç”¨æˆ·è¾“å…¥
messages = [
  { role: "user", content: "å¸®æˆ‘ä¿®å¤ app.js çš„ bug" }
]

// â”€â”€ ç¬¬1è½® API è°ƒç”¨ â”€â”€
// Claude å“åº”ï¼šè¯·æ±‚ Read å·¥å…·
messages = [
  { role: "user", content: "å¸®æˆ‘ä¿®å¤ app.js çš„ bug" },
  { role: "assistant", content: [
    { type: "text", text: "æˆ‘æ¥æ£€æŸ¥ä¸€ä¸‹ä»£ç " },
    { type: "tool_use", id: "tu_001", name: "Read", input: { path: "app.js" } }
  ]}
]

// CLI æ‰§è¡Œ Read å·¥å…·åï¼Œè¿½åŠ  tool_result
messages = [
  { role: "user",      content: "å¸®æˆ‘ä¿®å¤ app.js çš„ bug" },
  { role: "assistant", content: [/* text + tool_use */] },
  { role: "user",      content: [  // â† tool_result ä»¥ user è§’è‰²è¿½åŠ ï¼
    { type: "tool_result", tool_use_id: "tu_001", content: "// app.js\nfunction foo() {...}" }
  ]}
]

// â”€â”€ ç¬¬2è½® API è°ƒç”¨ï¼ˆå¸¦ä¸Šå…¨éƒ¨å†å²ï¼‰â”€â”€
// Claude åˆ†ææ–‡ä»¶åï¼Œè¯·æ±‚ Write å·¥å…·
messages = [
  ...ä¹‹å‰æ‰€æœ‰æ¶ˆæ¯...,
  { role: "assistant", content: [
    { type: "text", text: "ç¬¬42è¡Œæœ‰é—®é¢˜ï¼Œæˆ‘æ¥ä¿®å¤" },
    { type: "tool_use", id: "tu_002", name: "Write", input: { path: "app.js", content: "..." } }
  ]},
  { role: "user", content: [
    { type: "tool_result", tool_use_id: "tu_002", content: "æ–‡ä»¶å†™å…¥æˆåŠŸ" }
  ]}
]

// â”€â”€ æœ€ç»ˆè½®ï¼ˆstop_reason: end_turnï¼‰â”€â”€
messages = [
  ...æ‰€æœ‰å†å²æ¶ˆæ¯...,
  { role: "assistant", content: [
    { type: "text", text: "å·²å®Œæˆä¿®å¤ï¼Œç¬¬42è¡Œçš„ null check é—®é¢˜å·²è§£å†³" }
    // æ³¨æ„ï¼šæ²¡æœ‰ tool_useï¼â†’ stop_reason = "end_turn"
  ]}
]
```

### å…³é”®è§„åˆ™

```
âš ï¸ å¿…é¡»ç†è§£çš„çº¦æŸï¼š

1. tool_result å¿…é¡»ç´§è·Ÿå¯¹åº”çš„ tool_useï¼Œè§’è‰²ä¸º "user"
2. æ¯ä¸ª tool_use éƒ½æœ‰å”¯ä¸€ idï¼Œtool_result é€šè¿‡ tool_use_id ä¸ä¹‹å¯¹åº”
3. å¹¶è¡Œå·¥å…·è°ƒç”¨æ—¶ï¼Œå¤šä¸ª tool_result åœ¨åŒä¸€ä¸ª user message ä¸­
4. messages é¡ºåºå¿…é¡»æ˜¯ user/assistant äº¤æ›¿ï¼ˆAPI å¼ºåˆ¶è¦æ±‚ï¼‰
```

---

## 2.4 é”™è¯¯æ¢å¤æœºåˆ¶ï¼šå·¥å…·æŠ¥é”™åå¦‚ä½•é‡è¯•

### é”™è¯¯å¤„ç†æµç¨‹

```
å·¥å…·æ‰§è¡Œå¤±è´¥
    â”‚
    â–¼
CLI å°†é”™è¯¯ä¿¡æ¯å°è£…ä¸º tool_resultï¼ˆå¸¦ is_error: trueï¼‰
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tool_result = {                              â”‚
â”‚   tool_use_id: "tu_001",                    â”‚
â”‚   content: "Error: File not found: foo.js", â”‚
â”‚   is_error: true   â† å…³é”®æ ‡å¿—               â”‚
â”‚ }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
å‘é€ç»™ Claudeï¼Œç»§ç»­ä¸‹ä¸€è½® API è°ƒç”¨
    â”‚
    â–¼
Claude çœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼Œè‡ªä¸»å†³ç­–ï¼š
  â”œâ”€â”€ å°è¯•ä¸åŒçš„è·¯å¾„é‡è¯•
  â”œâ”€â”€ å…ˆç”¨ Glob æœç´¢æ–‡ä»¶å†è¯»å–
  â”œâ”€â”€ å‘ŠçŸ¥ç”¨æˆ·æ–‡ä»¶ä¸å­˜åœ¨
  â””â”€â”€ æ¢ä¸€ç§æ–¹æ³•è§£å†³åŒæ ·çš„ç›®æ ‡
```

### å¸¸è§é”™è¯¯åœºæ™¯ä¸ Claude çš„è‡ªåŠ¨åº”å¯¹

| é”™è¯¯ç±»å‹             | Claude çš„å…¸å‹åº”å¯¹ç­–ç•¥              |
| -------------------- | ---------------------------------- |
| æ–‡ä»¶ä¸å­˜åœ¨           | ç”¨ Glob æœç´¢ç›¸ä¼¼æ–‡ä»¶åï¼Œæˆ–è¯¢é—®ç”¨æˆ· |
| Bash å‘½ä»¤å¤±è´¥        | åˆ†æé”™è¯¯è¾“å‡ºï¼Œå°è¯•ä¿®å¤å‘½ä»¤åé‡è¯•   |
| å†™å…¥æƒé™ä¸è¶³         | æŠ¥å‘Šæƒé™é—®é¢˜ï¼Œè¯·ç”¨æˆ·ç¡®è®¤           |
| ç½‘ç»œè¶…æ—¶ï¼ˆMCPï¼‰      | é‡è¯•æˆ–å‘ŠçŸ¥ç”¨æˆ·                     |
| è¯­æ³•é”™è¯¯ï¼ˆæµ‹è¯•å¤±è´¥ï¼‰ | è¯»å–é”™è¯¯æ—¥å¿—ï¼Œä¿®å¤ä»£ç ï¼Œå†æ¬¡æµ‹è¯•   |

### æ— é™å¾ªç¯çš„è¯†åˆ«ä¸é˜²æŠ¤

```
å±é™©æ¨¡å¼ï¼šAgent é™·å…¥æ— æ•ˆå¾ªç¯
  å¾ªç¯1: Bash("npm test") â†’ æŠ¥é”™
  å¾ªç¯2: Read("test.js") â†’ è¯»å–
  å¾ªç¯3: Write("test.js", ç›¸åŒå†…å®¹) â†’ å†™å…¥
  å¾ªç¯4: Bash("npm test") â†’ åŒæ ·æŠ¥é”™
  ...ï¼ˆæ— è¿›å±•ï¼Œé‡å¤ï¼‰

Claude Code çš„é˜²æŠ¤æœºåˆ¶ï¼š
  âœ… æœ€å¤§è¿­ä»£æ¬¡æ•°é™åˆ¶ï¼ˆé»˜è®¤100æ¬¡ï¼‰
  âœ… ç”¨æˆ·å¯éšæ—¶ Ctrl+C æ‰“æ–­
  âœ… Claude æ¨¡å‹è‡ªèº«ä¼šæ£€æµ‹è¿›åº¦åœæ»å¹¶æ”¹å˜ç­–ç•¥
  âœ… Hooks å¯æ³¨å…¥é¢å¤–ä¸Šä¸‹æ–‡æç¤ºï¼ˆè§æ¨¡å—å…«ï¼‰
```

---

## 2.5 å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆParallel Tool Useï¼‰

Claude Code æ”¯æŒåœ¨å•æ¬¡å“åº”ä¸­**åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·**ï¼š

```javascript
// Claude çš„ä¸€æ¬¡å“åº”ä¸­åŒ…å«å¤šä¸ª tool_use
{
  role: "assistant",
  content: [
    { type: "text", text: "æˆ‘åŒæ—¶è¯»å–è¿™ä¸‰ä¸ªæ–‡ä»¶" },
    { type: "tool_use", id: "tu_001", name: "Read", input: { path: "a.js" } },
    { type: "tool_use", id: "tu_002", name: "Read", input: { path: "b.js" } },
    { type: "tool_use", id: "tu_003", name: "Read", input: { path: "c.js" } },
  ]
}

// CLI å¹¶è¡Œæ‰§è¡Œä¸‰ä¸ª Readï¼Œç»Ÿä¸€åœ¨ä¸€ä¸ª user message ä¸­è¿”å›
{
  role: "user",
  content: [
    { type: "tool_result", tool_use_id: "tu_001", content: "// a.js å†…å®¹" },
    { type: "tool_result", tool_use_id: "tu_002", content: "// b.js å†…å®¹" },
    { type: "tool_result", tool_use_id: "tu_003", content: "// c.js å†…å®¹" },
  ]
}
```

**å¹¶è¡Œæ‰§è¡Œçš„å¥½å¤„**ï¼šè¯»å–å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œé€Ÿåº¦æå‡ N å€ï¼ˆå¹¶å‘ I/O è€Œéä¸²è¡Œï¼‰

---

## 2.6 å®éªŒï¼šæ‰‹åŠ¨æ¨¡æ‹Ÿä¸€æ¬¡ Agent Loop

ç”¨ Node.js ä»£ç ä½“éªŒ Agent Loop çš„å®Œæ•´æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```javascript
import Anthropic from "@anthropic-ai/sdk";
import fs from "fs";

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

// æ¨¡æ‹Ÿå·¥å…·ï¼šåªå®ç° Read
const tools = [
  {
    name: "Read",
    description: "è¯»å–æ–‡ä»¶å†…å®¹",
    input_schema: {
      type: "object",
      properties: { path: { type: "string", description: "æ–‡ä»¶è·¯å¾„" } },
      required: ["path"],
    },
  },
];

async function executeTool(name, input) {
  if (name === "Read") {
    try {
      return fs.readFileSync(input.path, "utf-8");
    } catch (e) {
      return `Error: ${e.message}`;
    }
  }
  return "Unknown tool";
}

async function agentLoop(userInput) {
  const messages = [{ role: "user", content: userInput }];
  let iteration = 0;
  const MAX_ITERATIONS = 10;

  while (iteration < MAX_ITERATIONS) {
    iteration++;
    console.log(`\n=== ç¬¬ ${iteration} è½®å¾ªç¯ ===`);

    // 1. THINKï¼šè°ƒç”¨ API
    const response = await client.messages.create({
      model: "claude-opus-4-5",
      max_tokens: 4096,
      tools,
      messages,
    });

    console.log("stop_reason:", response.stop_reason);

    // è¿½åŠ  assistant æ¶ˆæ¯åˆ°å†å²
    messages.push({ role: "assistant", content: response.content });

    // 2. åˆ¤æ–­æ˜¯å¦ç»“æŸ
    if (response.stop_reason === "end_turn") {
      const text = response.content.find((b) => b.type === "text");
      console.log("\nâœ… ä»»åŠ¡å®Œæˆ:", text?.text);
      break;
    }

    // 3. ACT + OBSERVEï¼šæ‰§è¡Œå·¥å…·ï¼Œæ”¶é›†ç»“æœ
    if (response.stop_reason === "tool_use") {
      const toolResults = [];
      const toolUses = response.content.filter((b) => b.type === "tool_use");

      // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å·¥å…·
      for (const toolUse of toolUses) {
        console.log(
          `  æ‰§è¡Œå·¥å…·: ${toolUse.name}(${JSON.stringify(toolUse.input)})`,
        );
        const result = await executeTool(toolUse.name, toolUse.input);
        toolResults.push({
          type: "tool_result",
          tool_use_id: toolUse.id,
          content: result,
        });
      }

      // è¿½åŠ  tool_result åˆ°å†å²ï¼ˆä»¥ user è§’è‰²ï¼‰
      messages.push({ role: "user", content: toolResults });
    }
  }
}

// è¿è¡Œ
agentLoop("è¯»å– package.json å¹¶å‘Šè¯‰æˆ‘è¿™ä¸ªé¡¹ç›®çš„åç§°å’Œç‰ˆæœ¬å·");
```

**è¿è¡Œè¿™ä¸ªå®éªŒ**ï¼Œä½ å°†äº²çœ¼çœ‹åˆ° messages å¦‚ä½•éšæ¯è½®å¾ªç¯å¢é•¿ï¼

---

## 2.7 æ§åˆ¶æµé˜¶æ®µå¯¹ç…§ï¼ˆçŠ¶æ€æœºè§†è§’ï¼‰

ç»“åˆæ§åˆ¶æµåˆ†æè§†è§’ï¼Œå¯ä»¥æŠŠ Agent Loop çš„â€œThink â†’ Act â†’ Observeâ€æ˜ å°„ä¸ºæ›´ç»†ç²’åº¦çš„é˜¶æ®µï¼š

1. **Context é¢„ç®—ä¸å‹ç¼©**ï¼šè¿›å…¥ Think å‰å…ˆåˆ¤å®šæ˜¯å¦éœ€è¦ compactionï¼Œé¿å…è¶…é™å¯¼è‡´å¤±è´¥ã€‚
2. **System Prompt ç»„è£…**ï¼šæ„å»ºæœ¬è½®è¯·æ±‚ï¼ˆCLAUDE.mdã€å·¥å…·å®šä¹‰ã€repo ç»“æ„ç­‰ï¼‰ã€‚
3. **æµå¼ç”Ÿæˆä¸è§£æ**ï¼šé€šè¿‡ SSE äº‹ä»¶é©±åŠ¨çŠ¶æ€æœºï¼Œå¢é‡è§£æ text ä¸ tool_use è¾“å…¥ã€‚
4. **å·¥å…·æ‰§è¡Œç®¡çº¿**ï¼šåªè¯»å¯å¹¶è¡Œã€å†™å…¥é¡ºåºæ‰§è¡Œï¼Œå½¢æˆ tool_resultã€‚
5. **æƒé™è£å†³**ï¼šå·¥å…·æ‰§è¡Œå‰è¿›è¡Œ allow/ask/deny å†³ç­–ã€‚
6. **é€’å½’è½®æ¬¡**ï¼štool_result è¿½åŠ åˆ° messages åè¿›å…¥ä¸‹ä¸€è½®ï¼Œç›´åˆ° stop_reason == end_turnã€‚

è¿™å¥—åˆ†è§£èƒ½å¸®åŠ©ä½ ç†è§£ï¼šAgent Loop ä¸åªæ˜¯â€œæ€è€ƒ/è¡ŒåŠ¨/è§‚å¯Ÿâ€ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯æ‹†åˆ†çš„ç¼–æ’æµæ°´çº¿ã€‚

---

## ğŸ”‘ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

| çŸ¥è¯†ç‚¹            | å…³é”®ç»“è®º                                           |
| ----------------- | -------------------------------------------------- |
| **å¾ªç¯æœ¬è´¨**      | å•çº¿ç¨‹ while å¾ªç¯ï¼Œç®€å•ä½†å¼ºå¤§                      |
| **ç»ˆæ­¢ä¿¡å·**      | `stop_reason === "end_turn"` æ—¶é€€å‡º                |
| **è¿­ä»£ä¸Šé™**      | é»˜è®¤ 100 æ¬¡ï¼Œé˜²æ­¢æ­»å¾ªç¯                            |
| **messages å¢é•¿** | æ¯è½®è¿½åŠ  assistant + user(tool_result)ï¼Œçº¿æ€§å¢é•¿   |
| **é”™è¯¯å¤„ç†**      | `is_error: true` çš„ tool_result è®© Claude è‡ªä¸»åº”å¯¹ |
| **å¹¶è¡Œå·¥å…·**      | å•æ¬¡å“åº”å¯å«å¤šä¸ª tool_useï¼ŒCLI å¹¶å‘æ‰§è¡Œæé€Ÿ        |
| **ç”¨æˆ·æ‰“æ–­**      | é€šè¿‡ h2A é˜Ÿåˆ—å®ç°å®‰å…¨ä¸­æ–­ï¼Œä¸ä¼šæŸåæ–‡ä»¶            |

---

## ğŸ“ æ€è€ƒé¢˜

1. å¦‚æœ Claude è¿ç»­ 3 è½®éƒ½è°ƒç”¨åŒä¸€ä¸ªå·¥å…·ä½†æ²¡æœ‰è¿›å±•ï¼Œä½ ä¼šå¦‚ä½•æ£€æµ‹å¹¶æ‰“ç ´æ­»å¾ªç¯ï¼Ÿ
   - **è§£ç­”**ï¼šå¯ä»¥é€šè¿‡åœ¨ `agentLoop` ä¸­ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨æˆ–å“ˆå¸Œè¡¨ï¼Œè®°å½•æœ€è¿‘å‡ è½®çš„ `tool_use` åç§°å’Œå‚æ•°ã€‚å¦‚æœæ£€æµ‹åˆ°è¿ç»­å¤šæ¬¡å®Œå…¨ç›¸åŒçš„è°ƒç”¨ä¸” `tool_result` ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼Œå¯ä»¥åœ¨ä¸‹ä¸€è½® `user` æ¶ˆæ¯ä¸­æ³¨å…¥å¹²é¢„æç¤ºï¼ˆå¦‚â€œä½ å·²é™·å…¥æ­»å¾ªç¯ï¼Œè¯·å°è¯•å…¶ä»–æ–¹æ³•â€ï¼‰ï¼Œæˆ–è€…ç›´æ¥å¼ºåˆ¶ç»ˆæ­¢å¹¶æŠ¥é”™ã€‚

2. å¹¶è¡Œå·¥å…·è°ƒç”¨ä¸­ï¼Œå¦‚æœ `tu_001` æˆåŠŸè€Œ `tu_002` å¤±è´¥ï¼ŒClaude æ”¶åˆ°æ··åˆç»“æœåä¼šæ€ä¹ˆåšï¼Ÿ
   - **è§£ç­”**ï¼šClaude ä¼šæ ¹æ® `tool_result` ä¸­çš„ `is_error` å­—æ®µåŒºåˆ†å¯¹å¾…ã€‚å®ƒä¼šåˆ©ç”¨ `tu_001` è¿”å›çš„æœ‰æ•ˆä¿¡æ¯ç»§ç»­ä»»åŠ¡ï¼ŒåŒæ—¶åˆ†æ `tu_002` çš„æŠ¥é”™åŸå› ï¼ˆå¦‚å‚æ•°é”™è¯¯ã€æ–‡ä»¶ä¸å­˜åœ¨ç­‰ï¼‰ï¼Œåœ¨ä¸‹ä¸€è½®å¾ªç¯ä¸­å°è¯•ä¿®æ­£é”™è¯¯æˆ–å‘ç”¨æˆ·åé¦ˆå¤±è´¥ã€‚

3. messages çº¿æ€§å¢é•¿ â†’ context è¶Šæ¥è¶Šé•¿ â†’ å¦‚ä½•è§£å†³ï¼Ÿï¼ˆâ†’ æ¨¡å—äº”ï¼šContext ç®¡ç†ï¼‰
   - **è§£ç­”**ï¼šå¯ä»¥é€šè¿‡æˆªæ–­ï¼ˆTruncationï¼‰ã€æ€»ç»“ï¼ˆSummarizationï¼‰æˆ–ä½¿ç”¨ Prompt Caching æ¥ä¼˜åŒ–ã€‚åœ¨åç»­çš„â€œæ¨¡å—äº”â€ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºå¦‚ä½•é€šè¿‡æ»‘åŠ¨çª—å£æœºåˆ¶å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡å‹ç¼©æ¥ç»´æŒé•¿æ•ˆå¯¹è¯ã€‚

4. ä¸ºä»€ä¹ˆ tool_result çš„ role æ˜¯ `"user"` è€Œä¸æ˜¯ `"tool"` æˆ–å…¶ä»–ï¼Ÿ
   - **è§£ç­”**ï¼šè¿™æ˜¯ Anthropic Messages API çš„è®¾è®¡è§„èŒƒã€‚åœ¨ API å±‚é¢ï¼Œå¯¹è¯ç”± `user` å’Œ `assistant` äº¤æ›¿è¿›è¡Œã€‚å·¥å…·æ‰§è¡Œç»“æœè¢«è§†ä¸ºç¯å¢ƒï¼ˆä½œä¸ºç”¨æˆ·çš„å»¶ä¼¸ï¼‰å¯¹æ¨¡å‹è¯·æ±‚çš„åé¦ˆï¼Œå› æ­¤å¿…é¡»æ”¾åœ¨ `user` è§’è‰²çš„æ¶ˆæ¯ä¸­ã€‚è¿™ç§è®¾è®¡ä¿æŒäº†è§’è‰²æ¨¡å‹çš„ç®€æ´æ€§ï¼Œå°†æ‰€æœ‰éæ¨¡å‹ç”Ÿæˆçš„å†…å®¹ç»Ÿä¸€å½’ç±»ä¸ºç”¨æˆ·è¾“å…¥ã€‚

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Anthropicï¼šTool Use Overview](https://docs.anthropic.com/en/docs/build-with-claude/tool-use/overview)
- [Anthropicï¼šAgentic Loop Best Practices](https://docs.anthropic.com/en/docs/build-with-claude/tool-use/implement-tool-use)
- [Building Effective Agentsï¼ˆAnthropic å®˜æ–¹åšå®¢ï¼‰](https://www.anthropic.com/research/building-effective-agents)

---

> âœ… æ¨¡å—äºŒå®Œæˆã€‚ä¸‹ä¸€æ­¥ï¼š**æ¨¡å—ä¸‰ - Tool Use å·¥å…·è°ƒç”¨ç³»ç»Ÿ**
